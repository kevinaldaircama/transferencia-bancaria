<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de VPS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .close {
      position: absolute;
      top: 10px; right: 15px;
      font-size: 24px; cursor: pointer;
    }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body class="bg-dark text-white p-4">
  <h2>üõ†Ô∏è Generador de VPS</h2>
  <p class="text-warning mb-4">
    Puedes sacar las VPS que quieras, pero se descontar√°n <strong>6 cr√©ditos</strong> por cada una.
  </p>

  <div class="mb-3">
    <label>Localizaci√≥n:</label>
    <select id="localizacion" class="form-control">
      <option>Estados Unidos</option>
      <option>Per√∫</option>
      <option>Aleatorio</option>
    </select>
  </div>
  <input id="usuario" class="form-control mb-2" placeholder="Nombre de usuario">
  <input id="contrasena" class="form-control mb-2" placeholder="Contrase√±a">
  <input id="dias" type="number" class="form-control mb-2" placeholder="D√≠as de duraci√≥n (m√°x 30)">
  <input id="limite" type="number" class="form-control mb-3" placeholder="L√≠mite de conexi√≥n (m√°x 500)">
  <button onclick="generarVPS()" class="btn btn-primary">Generar VPS</button>

  <!-- Modal -->
  <div class="modal fade" id="modalVPS" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content p-4 position-relative text-black" id="modalClick">
        <span class="close" onclick="cerrarModal()">&times;</span>
        <div id="modalContenido"></div>
        <div id="copiadoMsg" class="text-success mt-2" style="display:none;">üìã Copiado al portapapeles</div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBMw3Zbb-rcXoOXlT1U-WWN1N4L4bk1aCk",
      authDomain: "sistema-27b31.firebaseapp.com",
      databaseURL: "https://sistema-27b31-default-rtdb.firebaseio.com",
      projectId: "sistema-27b31",
      storageBucket: "sistema-27b31.appspot.com",
      messagingSenderId: "32031316083",
      appId: "1:32031316083:web:32cef8736c5a77fbb9f206"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    auth.onAuthStateChanged(user => {
      if (!user) window.location.href = "index.html";
    });

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("modalClick").addEventListener("click", () => {
        const text = document.getElementById("modalContenido").innerText;
        navigator.clipboard.writeText(text).then(() => {
          document.getElementById("copiadoMsg").style.display = 'block';
          setTimeout(() => document.getElementById("copiadoMsg").style.display = 'none', 2000);
        });
      });
    });

    function cerrarModal() {
      const modal = bootstrap.Modal.getInstance(document.getElementById('modalVPS'));
      modal.hide();
    }

    async function generarVPS() {
      const loc = document.getElementById("localizacion").value;
      const user = document.getElementById("usuario").value.trim();
      const pass = document.getElementById("contrasena").value.trim();
      const dias = parseInt(document.getElementById("dias").value);
      const limite = parseInt(document.getElementById("limite").value);

      if (!user || !pass || !dias || !limite) return alert("Completa todos los campos.");
      if (dias > 30) return alert("M√°ximo 30 d√≠as.");
      if (limite > 500) return alert("M√°ximo 500 conexiones.");

      const usuario = auth.currentUser;
      if (!usuario) return window.location.href = "login.html";

      const UID = usuario.uid;
      const creditosRef = db.ref(`usuarios/${UID}/saldousuario`);
      const snapshot = await creditosRef.get();
      const creditos = parseFloat(snapshot.val() || 0);

      if (creditos < 6) return alert("Cr√©ditos insuficientes.");

      mostrarModal("Procesando datos...");
      await esperar(3000);
      mostrarModal("Procesando cr√©ditos...");
      await esperar(2000);

      const ip = "137.184.106.106";
      const fechaExp = new Date();
      fechaExp.setDate(fechaExp.getDate() + dias);
      const fechaFormateada = fechaExp.toLocaleDateString('es-ES');

      await creditosRef.set((creditos - 6).toFixed(2));

      const nuevaVPS = {
        ip, usuario: user, contrasena: pass, dias, limite,
        localizacion: loc, fechaExpiracion: fechaFormateada,
        fechaCreacion: new Date().toLocaleString('es-ES'), uid: UID
      };
      await db.ref("admin/vpsGeneradas").push(nuevaVPS);

      mostrarModal(`
        <h5 class="text-success">üéâ Felicidades, tu VPS fue creado con √©xito</h5>
        <hr>
<pre>
IP de Servidor: ${ip}
Usuario: ${user}
Contrase√±a: ${pass}
D√≠as de Duraci√≥n: ${dias}
Fecha de Expiraci√≥n: ${fechaFormateada}
L√≠mite de Conexi√≥n: ${limite}
------------------------------
SSH: 22
DROPBEAR: 80 90
SSL: 443
SQUID: 3128
Bad VPN: 7300
Python: 100
------------------------------
PAYLOAD WEBSOCKET:
GET / HTTP/1.1[crlf]Host: ${ip}[crlf]Upgrade: websocket[crlf][crlf]
</pre>
<small class="text-muted">Haz clic para copiar la informaci√≥n</small>
      `);
    }

    function mostrarModal(contenido) {
      document.getElementById("modalContenido").innerHTML = contenido;
      new bootstrap.Modal(document.getElementById('modalVPS')).show();
    }

    function esperar(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
  </script>
</body>
</html>
