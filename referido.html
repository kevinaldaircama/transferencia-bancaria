<!-- Panel de Referidos Actualizado con Modal y CrÃ©ditos --><!DOCTYPE html><html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Referidos</title>
  <style>
  * {
    box-sizing: border-box;
  }

  body {
    font-family: 'Segoe UI', sans-serif;
    background-color: #eef2f7;
    margin: 0;
    padding: 0;
    color: #333;
  }

  .container {
    max-width: 1200px;
    margin: 20px auto;
    padding: 20px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  h2 {
    text-align: center;
    margin-bottom: 30px;
  }

  .ref-link, .filters {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
  }

  .ref-link input, .filters input, .filters select {
    flex: 1 1 250px;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
    transition: border-color 0.3s;
  }

  .ref-link button, .filters button {
    padding: 12px 18px;
    background: #5c6bc0;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s;
  }

  .ref-link button:hover, .filters button:hover {
    background: #3f51b5;
  }

  .stats, .comisiones {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
  }

  .card {
    padding: 20px;
    border-radius: 12px;
    color: white;
    text-align: center;
    font-weight: bold;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }

  .blue { background: #3f51b5; }
  .green { background: #43a047; }
  .yellow { background: #fdd835; color: #333; }
  .purple { background: #8e24aa; }

  .card button {
    margin-top: 10px;
    padding: 10px 15px;
    border: none;
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    cursor: pointer;
    transition: background 0.3s;
  }

  .card button:hover {
    background: rgba(255, 255, 255, 0.35);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background: #fff;
  }

  th, td {
    text-align: left;
    padding: 12px;
    border-bottom: 1px solid #e0e0e0;
  }

  th {
    background-color: #f5f5f5;
    font-weight: 600;
  }

  .no-data {
    text-align: center;
    padding: 40px;
    color: #777;
  }

  #modal {
    display: none;
    position: fixed;
    z-index: 999;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background: #fff;
    padding: 30px 20px;
    border-radius: 10px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }

  .modal-content p {
    margin-bottom: 20px;
    font-size: 18px;
  }

  .modal-content button {
    margin: 10px;
    padding: 10px 18px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
  }

  .modal-content .yes { background: #4caf50; color: white; }
  .modal-content .no { background: #f44336; color: white; }

  /* Responsive */
  @media (max-width: 768px) {
    .ref-link, .filters {
      flex-direction: column;
    }

    .ref-link input, .filters input, .filters select, .ref-link button, .filters button {
      width: 100%;
      margin-right: 0;
    }
  }
</style>
</head>
<body>
<div class="container">
  <h2>Panel de Referidos</h2>
  <div class="ref-link">
    <input type="text" id="referralLink" readonly>
    <button onclick="copiarEnlace()">Copiar</button>
  </div>  <div class="stats">
    <div class="card blue">
      <h3>Total Referidos</h3>
      <p id="totalReferidos">0</p>
    </div>
    <div class="card green">
      <h3>Referidos Activos</h3>
      <p id="referidosActivos">0</p>
    </div>
  </div>  <div class="comisiones">
    <div class="card yellow">
      <h3>Comisiones Totales</h3>
      <p id="comisionesTotales">0.00 crÃ©ditos</p>
    </div>
    <div class="card purple">
      <h3>Comisiones Pendientes</h3>
      <p id="comisionesPendientes">0.00</p>
      <button onclick="mostrarModal()">Cobrar Comisiones</button>
    </div>
  </div>  <div class="filters">
    <input type="text" placeholder="Buscar por nombre de usuario...">
    <select>
      <option>MÃ¡s recientes</option>
      <option>MÃ¡s antiguos</option>
    </select>
    <button id="saldoTotal">Mi saldo actual: ðŸª™ 0</button>
    <button>Mis Recargas</button>
  </div>  <table>
    <thead>
      <tr>
        <th>Correo</th>
        <th>Fecha Registro</th>
        <th>Estado Usuario</th>
        <th>Saldo Recargado</th>
        <th>Recargas</th>
        <th>ComisiÃ³n</th>
        <th>Ãšltima Recarga</th>
      </tr>
    </thead>
    <tbody id="referidosTable">
      <tr>
        <td colspan="7" class="no-data">No se encontraron referidos<br><small>Comparte tu cÃ³digo para empezar a ganar</small></td>
      </tr>
    </tbody>
  </table>
</div><div id="modal">
  <div class="modal-content">
    <p>Â¿Deseas cobrar tus comisiones?</p>
    <button class="yes" onclick="cobrarComisiones()">SÃ­</button>
    <button class="no" onclick="cerrarModal()">No</button>
  </div>
</div><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script><script>
  const firebaseConfig = {
    apiKey: "AIzaSyBMw3Zbb-rcXoOXlT1U-WWN1N4L4bk1aCk",
    authDomain: "sistema-27b31.firebaseapp.com",
    databaseURL: "https://sistema-27b31-default-rtdb.firebaseio.com",
    projectId: "sistema-27b31",
    storageBucket: "sistema-27b31.appspot.com",
    messagingSenderId: "32031316083",
    appId: "1:32031316083:web:32cef8736c5a77fbb9f206"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  function copiarEnlace() {
    const input = document.getElementById('referralLink');
    input.select();
    document.execCommand('copy');
    alert('Â¡Enlace copiado!');
  }

  function mostrarModal() {
    document.getElementById('modal').style.display = 'flex';
  }

  function cerrarModal() {
    document.getElementById('modal').style.display = 'none';
  }

  function cobrarComisiones() {
    const uid = auth.currentUser.uid;
    db.ref(`usuarios/${uid}`).once('value').then(snap => {
      const datos = snap.val() || {};
      const pendientes = parseFloat(datos.comisionesPendientes || 0);
      const totales = parseFloat(datos.comisionesTotales || 0);
      if (pendientes > 0) {
        db.ref(`usuarios/${uid}`).update({
          comisionesPendientes: 0,
          comisionesTotales: (totales + pendientes)
        });
        document.getElementById('comisionesPendientes').innerText = '0.00';
        document.getElementById('comisionesTotales').innerText = (totales + pendientes).toFixed(2) + ' crÃ©ditos';
        document.getElementById('saldoTotal').innerText = 'Mi saldo actual: ðŸª™ ' + (totales + pendientes);
      }
      cerrarModal();
    });
  }

  function generarCodigo(uid) {
    return uid.substring(0, 2) + Math.floor(Math.random() * 100) + uid.substring(uid.length - 2);
  }

  auth.onAuthStateChanged(user => {
    if (!user) return window.location.href = 'login.html';
    const uid = user.uid;

    db.ref(`usuarios/${uid}/referidoId`).once('value').then(snapshot => {
      let refId = snapshot.val();
      if (!refId) {
        refId = generarCodigo(uid);
        db.ref(`usuarios/${uid}/referidoId`).set(refId);
      }

      document.getElementById('referralLink').value = `https://transferenciavip.netlify.app/referido/${refId}`;

      db.ref(`referidos/${refId}`).once('value', snap => {
        const data = snap.val();
        const tbody = document.getElementById('referidosTable');
        tbody.innerHTML = '';
        let total = 0, activos = 0;

        if (data) {
          for (let key in data) {
            const r = data[key];
            total++;
            if (r.estado === 'activo') activos++;
            tbody.innerHTML += `
              <tr>
                <td>${r.correo}</td>
                <td>${r.fecha}</td>
                <td>${r.estado}</td>
                <td>${r.saldo || '0.00'}</td>
                <td>${r.recargas || 0}</td>
                <td>${r.comision || '0.00'}</td>
                <td>${r.ultima || '-'}</td>
              </tr>`;
          }
        } else {
          tbody.innerHTML = `<tr><td colspan="7" class="no-data">No se encontraron referidos<br><small>Comparte tu cÃ³digo para empezar a ganar</small></td></tr>`;
        }

        document.getElementById('totalReferidos').innerText = total;
        document.getElementById('referidosActivos').innerText = activos;
      });

      db.ref(`usuarios/${uid}`).on('value', snap => {
        const userInfo = snap.val() || {};
        const total = parseFloat(userInfo.comisionesTotales || 0);
        const pendientes = parseFloat(userInfo.comisionesPendientes || 0);
        document.getElementById('comisionesTotales').innerText = total.toFixed(2) + ' crÃ©ditos';
        document.getElementById('comisionesPendientes').innerText = pendientes.toFixed(2);
        document.getElementById('saldoTotal').innerText = 'Mi saldo actual: ðŸª™ ' + (total + pendientes);
      });
    });
  });
</script></body>
</html>
