<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Retiros</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <style>
    body { background: #111; color: #fff; padding: 2rem; font-family: Arial; }
    .table td, .table th { color: #fff; vertical-align: middle; }
    .table th { background-color: #222; }
    select, h2 { margin-bottom: 1rem; }
    .btn-sm { margin-right: 5px; }
    .estado-pendiente { color: orange; }
    .estado-aprobado { color: lime; }
    .estado-rechazado { color: red; }
  </style>
</head>
<body>
  <h2>üìã Panel de Solicitudes de Retiros</h2>

  <select id="filtroEstado" class="form-select w-auto mb-3">
    <option value="todos">Todos</option>
    <option value="pendiente">Pendiente</option>
    <option value="aprobado">Aprobado</option>
    <option value="rechazado">Rechazado</option>
    <option value="reciente">M√°s reciente</option>
    <option value="antiguo">M√°s antiguo</option>
  </select>

  <table class="table table-dark table-bordered table-hover">
    <thead>
      <tr>
        <th>UID</th><th>Correo</th><th>Monto</th><th>Billetera</th><th>N√∫mero</th><th>Estado</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tablaRetiros"></tbody>
  </table>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBMw3Zbb-rcXoOXlT1U-WWN1N4L4bk1aCk",
  authDomain: "sistema-27b31.firebaseapp.com",
  databaseURL: "https://sistema-27b31-default-rtdb.firebaseio.com",
  projectId: "sistema-27b31",
  storageBucket: "sistema-27b31.appspot.com",
  messagingSenderId: "32031316083",
  appId: "1:32031316083:web:32cef8736c5a77fbb9f206"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const tabla = document.getElementById("tablaRetiros");
const filtro = document.getElementById("filtroEstado");
const adminPermitido = "kevinaldaircamachoserna51@gmail.com";

auth.onAuthStateChanged(user => {
  if (!user || user.email !== adminPermitido) {
    document.body.innerHTML = "<h3>Acceso denegado</h3>";
    return;
  }

  db.ref("retiros").on("value", snapshot => {
    const data = snapshot.val() || {};
    const filtroValor = filtro.value;
    let items = Object.entries(data);
    if (["pendiente", "aprobado", "rechazado"].includes(filtroValor)) {
      items = items.filter(([k, v]) => v.estado === filtroValor);
    }
    if (filtroValor === "reciente") items.sort((a,b)=>b[0]-a[0]);
    if (filtroValor === "antiguo") items.sort((a,b)=>a[0]-b[0]);

    tabla.innerHTML = items.map(([id, d]) => `
      <tr>
        <td>${d.uid}</td>
        <td>${d.correo}</td>
        <td>S/ ${parseFloat(d.monto).toFixed(2)}</td>
        <td>${d.billetera}</td>
        <td>${d.numero}</td>
        <td class="fw-bold estado-${d.estado}">${d.estado.toUpperCase()}</td>
        <td>
          <button class='btn btn-success btn-sm' onclick="actualizarEstado('${id}', '${d.uid}', 'aprobado')">‚úî Aprobar</button>
          <button class='btn btn-danger btn-sm' onclick="actualizarEstado('${id}', '${d.uid}', 'rechazado')">‚úñ Rechazar</button>
        </td>
      </tr>
    `).join("");
  });
});

filtro.addEventListener("change", () => auth.currentUser && auth.currentUser.email === adminPermitido && location.reload());

function actualizarEstado(id, uid, nuevoEstado) {
  db.ref("retiros/" + id).update({ estado: nuevoEstado }).then(() => {
    let mensaje = "";
    if (nuevoEstado === "aprobado") {
      mensaje = "‚úÖ Tu pago fue aprobado y el dinero ser√° enviado pronto.";
    } else if (nuevoEstado === "rechazado") {
      mensaje = "‚ùå Tu solicitud fue rechazada. Contacta con soporte.";
    }
    db.ref("notificaciones/" + uid).push({
      mensaje,
      timestamp: Date.now()
    });
    alert("‚úî Estado actualizado y notificaci√≥n enviada.");
  });
}
</script>
</body>
</html>
